<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-guidance/container-startup-time/reduce-container-image-size/decoupling-model-artifacts" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Decoupling model artifacts from container image | AI on EKS</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://awslabs.github.io/ai-on-eks/docs/guidance/container-startup-time/reduce-container-image-size/decoupling-model-artifacts"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Decoupling model artifacts from container image | AI on EKS"><meta data-rh="true" name="description" content="While the main purpose of extracting model artifacts is to reduce the container image size, this approach also provides additional operational and functional advantages. The operational improvements include separate versioning, streamlined auditing, and lifecycle control for model artifacts, while lazy-loading, hot-swapping, and reuse across different applications offer additional functional flexibility and performance. Depending on the use case these advantages can be decisive factors when selecting among the solutions outlined in this section."><meta data-rh="true" property="og:description" content="While the main purpose of extracting model artifacts is to reduce the container image size, this approach also provides additional operational and functional advantages. The operational improvements include separate versioning, streamlined auditing, and lifecycle control for model artifacts, while lazy-loading, hot-swapping, and reuse across different applications offer additional functional flexibility and performance. Depending on the use case these advantages can be decisive factors when selecting among the solutions outlined in this section."><link data-rh="true" rel="icon" href="/ai-on-eks/img/header-icon.png"><link data-rh="true" rel="canonical" href="https://awslabs.github.io/ai-on-eks/docs/guidance/container-startup-time/reduce-container-image-size/decoupling-model-artifacts"><link data-rh="true" rel="alternate" href="https://awslabs.github.io/ai-on-eks/docs/guidance/container-startup-time/reduce-container-image-size/decoupling-model-artifacts" hreflang="en"><link data-rh="true" rel="alternate" href="https://awslabs.github.io/ai-on-eks/docs/guidance/container-startup-time/reduce-container-image-size/decoupling-model-artifacts" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Solving cold start challenges for AI/ML inference applications on Amazon EKS","item":"https://awslabs.github.io/ai-on-eks/docs/guidance/container-startup-time/"},{"@type":"ListItem","position":2,"name":"Reducing container image size","item":"https://awslabs.github.io/ai-on-eks/docs/guidance/container-startup-time/reduce-container-image-size/"},{"@type":"ListItem","position":3,"name":"Decoupling model artifacts from container image","item":"https://awslabs.github.io/ai-on-eks/docs/guidance/container-startup-time/reduce-container-image-size/decoupling-model-artifacts"}]}</script><link rel="stylesheet" href="/ai-on-eks/assets/css/styles.f2fe9425.css">
<script src="/ai-on-eks/assets/js/runtime~main.d157f65d.js" defer="defer"></script>
<script src="/ai-on-eks/assets/js/main.6c2f188d.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/ai-on-eks/"><div class="navbar__logo"><img src="/ai-on-eks/img/header-icon.png" alt="AIoEKS Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/ai-on-eks/img/header-icon.png" alt="AIoEKS Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a class="navbar__item navbar__link" href="/ai-on-eks/docs/infra/ai-ml">Infrastructure</a><a class="navbar__item navbar__link" href="/ai-on-eks/docs/blueprints">Blueprints</a><a class="navbar__item navbar__link" href="/ai-on-eks/docs/resources/intro">Resources</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/ai-on-eks/docs/guidance">Guidance</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/awslabs/ai-on-eks" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ai-on-eks/docs/guidance">Guidance for AI workloads</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/ai-on-eks/docs/guidance/container-startup-time">Solving cold start challenges for AI/ML inference applications on Amazon EKS</a><button aria-label="Collapse sidebar category &#x27;Solving cold start challenges for AI/ML inference applications on Amazon EKS&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/ai-on-eks/docs/guidance/container-startup-time/reduce-container-image-size">Reducing container image size</a><button aria-label="Collapse sidebar category &#x27;Reducing container image size&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ai-on-eks/docs/guidance/container-startup-time/reduce-container-image-size/optimize-image-size">Optimizing container images size</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/ai-on-eks/docs/guidance/container-startup-time/reduce-container-image-size/decoupling-model-artifacts">Decoupling model artifacts from container image</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/ai-on-eks/docs/guidance/container-startup-time/accelerate-pull-process">Accelerating pull process</a><button aria-label="Expand sidebar category &#x27;Accelerating pull process&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/ai-on-eks/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/ai-on-eks/docs/guidance/container-startup-time"><span>Solving cold start challenges for AI/ML inference applications on Amazon EKS</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/ai-on-eks/docs/guidance/container-startup-time/reduce-container-image-size"><span>Reducing container image size</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Decoupling model artifacts from container image</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Decoupling model artifacts from container image</h1></header>
<p>While the main purpose of extracting model artifacts is to reduce the container image size, this approach also provides additional operational and functional advantages. The operational improvements include separate versioning, streamlined auditing, and lifecycle control for model artifacts, while lazy-loading, hot-swapping, and reuse across different applications offer additional functional flexibility and performance. Depending on the use case these advantages can be decisive factors when selecting among the solutions outlined in this section.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-init-containers-to-download-model-artifacts-from-amazon-s3">Using init containers to download model artifacts from Amazon S3<a href="#using-init-containers-to-download-model-artifacts-from-amazon-s3" class="hash-link" aria-label="Direct link to Using init containers to download model artifacts from Amazon S3" title="Direct link to Using init containers to download model artifacts from Amazon S3">​</a></h2>
<p>This solution provides a straightforward approach to extracting any model files or associated artifacts to an external storage. The artifacts are tagged, versioned and placed in an Amazon S3 bucket during the development or CI/CD phases, along with the appropriate lifecycle policy to control their retention. Once referenced by an application, they are downloaded to shared volumes during the application’s pod initialization using the Kubernetes native <a href="https://kubernetes.io/docs/concepts/workloads/pods/init-containers/" target="_blank" rel="noopener noreferrer">init containers</a>, which are executed sequentially before the main application container.</p>
<p><strong>Architecture overview</strong></p>
<p>The diagram in Figure 1 shows the architecture for the solution, which includes the personas, AWS services, Kubernetes components, and artifacts that are being created, stored and retrieved as part of the data flow.</p>
<p><img decoding="async" loading="lazy" alt="Figure 1: Init containers architecture to retrieve model artifacts from Amazon S3" src="/ai-on-eks/assets/images/init-container-f396f3fd955f3893f9f20383700973e5.png" width="7920" height="3824" class="img_ev3q">
<em>Figure 1: Init containers architecture to retrieve model artifacts from Amazon S3</em></p>
<p><strong>Implementation guide</strong></p>
<p>Following the architecture diagram above, these are the main high-level steps for each of the teams.</p>
<p>The DevOps/MLOps/Platform team:</p>
<ol>
<li>alters the Kubernetes deployment manifest (e.g., YAML files, Helm charts) to include init containers,</li>
<li>implements, using the init containers that are executed first, the steps to download model artifacts to an EC2 volume</li>
<li>alters the Kubernetes deployment manifests to:<!-- -->
<ol>
<li>define a volume shared between init containers and the application container</li>
<li>mount the volume under the expected paths in the application container</li>
</ol>
</li>
<li>adjusts pod IAM permissions to allow init containers to access the appropriate prefix in the bucket</li>
<li>creates an Amazon S3 bucket to store model artifacts</li>
<li>alters the container image definition to exclude the model artifacts during the build stage</li>
</ol>
<p>ML or application teams:</p>
<ol>
<li>upload model artifacts to an Amazon S3 bucket (as part of their SDLC)</li>
<li>continue to push their container image changes to Amazon ECR, as before</li>
<li>continue to use the Kubernetes deployment manifests to define the application Kubernetes deployment, as before</li>
</ol>
<p>The following code shows an already-adjusted Kubernetes deployment manifest:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: my-inference-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: apps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app.kubernetes.io/name: my-inference-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app.kubernetes.io/name: my-inference-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serviceAccountName: my-inference-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      initContainers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: download</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          image: peakcom/s5cmd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          command:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - /bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - -c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - &#x27;/s5cmd sync s3://my-ml-bucket/model-artifacts/my-model-1.2.3/* /model-artifacts/my-model-1.2.3&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - mountPath: /model-artifacts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              name: model-artifacts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          image: &lt;account-id&gt;.dkr.ecr.&lt;region&gt;.amazonaws.com/my-inference-app:3.5.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: app-port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              containerPort: 6060</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - mountPath: /app/model-artifacts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              name: model-artifacts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - emptyDir: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name: model-artifacts</span><br></span></code></pre></div></div>
<p>The example above follows the steps outlined above and uses <a href="https://github.com/peak/s5cmd" target="_blank" rel="noopener noreferrer">s5cmd</a>, which is an open-source tool that provides <a href="https://github.com/peak/s5cmd/blob/master/README.md#Benchmarks" target="_blank" rel="noopener noreferrer">excellent performance</a> for downloading files from Amazon S3. The implementation relies on the fact that the current, everything-in-image solution bundles the <code>my-model-1.2.3</code> model artifacts in the container image under the <code>/app/model-artifacts</code> and mimics that behavior by placing them in the same location.</p>
<p>Note that the <code>my-inference-app</code> service account listed in the manifest above needs to have the appropriate IAM permissions to read from the corresponding prefix in the <code>my-ml-bucket</code> bucket. On Amazon EKS, the recommended way to achieve that is to use <a href="https://docs.aws.amazon.com/eks/latest/userguide/pod-identities.html" target="_blank" rel="noopener noreferrer">Amazon EKS Pod Identity add-on</a>. Amazon EKS Pod Identity provides a way to create, via the AWS API, an association between a Kubernetes service account and an AWS IAM role. When deployed, Pod Identity add-on places an agent (via DaemonSet) on every node in the cluster. and then allows pods with that service account to extract the required credentials, at runtime, from that agent.</p>
<p><strong>Main benefits</strong></p>
<p>This solution implements the high-level approach of improving AI/ML inference application containers startup performance by reducing the container image size. Depending on networking conditions, and <code>s5cmd</code> superior performance, it may also improve the image pull directly.</p>
<p><strong>Additional benefits</strong></p>
<p>In addition to the main benefit, the solution introduces the following potential additional benefits:</p>
<ul>
<li>Ability to update model versions separately from the application, without rebuilding the container image</li>
<li>Ability to A/B test, hot-swap or rollback models, without rebuilding or increasing the container image size</li>
<li>Ability to share models between different applications without packaging them into all container images</li>
<li>Reduction in storage cost and ability to utilize Amazon S3 storage classes, include Intelligent-Tiering</li>
<li>Ability to have a fine-grained control over access to models with Amazon EKS Pod Identity <a href="https://docs.aws.amazon.com/eks/latest/userguide/pod-id-abac.html" target="_blank" rel="noopener noreferrer">session tags</a></li>
<li>Faster container builds, aiding experimentation and testing</li>
<li>Minimal changes in the ML or application teams workflow</li>
<li>Simple cross-region replication</li>
</ul>
<p><strong>Trade-offs</strong></p>
<p>The trade-offs include:</p>
<ul>
<li>Additional operational complexity of making the required CI/CD changes and handling the download process, including retries, error handling, backoff etc.</li>
<li>Additional storage and cleanup management, which essentially replicates the ECR functionality</li>
<li>In cases where additional replicas of the application often land on the same EC2 instances, having the image stored in on-host container runtime cache may be more beneficial to their containers startup time</li>
</ul>
<p><strong>Variants and hybrid solutions</strong></p>
<p>This solution integrates well with the <a href="/ai-on-eks/docs/guidance/container-startup-time/accelerate-pull-process">Accelerating pull process</a> group of solutions, improving both the container image size and its pull time.</p>
<p>For AI/ML inference application that read the artifacts into memory, skipping the intermediate step of storing them on the local disk, the “Using Mountpoint CSI Driver to read model artifacts into memory directly from Amazon S3” solution may replace or be used in addition to improve the download performance further.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-amazon-file-storage-services-to-host-model-artifacts">Using Amazon File Storage services to host model artifacts<a href="#using-amazon-file-storage-services-to-host-model-artifacts" class="hash-link" aria-label="Direct link to Using Amazon File Storage services to host model artifacts" title="Direct link to Using Amazon File Storage services to host model artifacts">​</a></h2>
<p>This section covers different Amazon FSx services that can be used to decouple the model artifacts from a container image. Amazon FSx offers a range of services like FSx for OpenZFS, FSx for Lustre, or FSx for NetApp ONTAP. These services differs by the technology that back them, and have different performance and scale characteristics. To learn more about these services, refer to the <a href="https://aws.amazon.com/fsx/when-to-choose-fsx/" target="_blank" rel="noopener noreferrer">documentation</a>.</p>
<p>Choosing the appropriate Amazon FSx service depends on the characteristics of your use case. Factors like the size of the model, the number of models, update frequency, and the number of clients that pull the models, may impact the chosen service.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This section is WIP, and will get more FSx service specific guides in the future.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="using-trident-csi-driver-to-provide-access-to-model-artifacts-on-amazon-fsx-for-netapp-ontap">Using Trident CSI driver to provide access to model artifacts on Amazon FSx for NetApp ONTAP<a href="#using-trident-csi-driver-to-provide-access-to-model-artifacts-on-amazon-fsx-for-netapp-ontap" class="hash-link" aria-label="Direct link to Using Trident CSI driver to provide access to model artifacts on Amazon FSx for NetApp ONTAP" title="Direct link to Using Trident CSI driver to provide access to model artifacts on Amazon FSx for NetApp ONTAP">​</a></h3>
<p><strong>Architecture overview</strong></p>
<p>The diagram in Figure 2 shows the architecture for the solution, which includes the personas, AWS services, Kubernetes components, and artifacts that are being created, stored and retrieved as part of the data flow.</p>
<p><img decoding="async" loading="lazy" alt="Figure 2: Using Trident CSI driver to store and access model artifacts on FSx for NetApp ONTAP" src="/ai-on-eks/assets/images/fsxn-eeedcc28e826980f216dd70176ebddd1.png" width="8156" height="3636" class="img_ev3q">
<em>Figure 2: Using Trident CSI driver to store and access model artifacts on FSx for NetApp ONTAP</em></p>
<p><strong>Implementation guide</strong></p>
<p>Following the architecture diagram above, these are the main high-level steps for each of the teams.</p>
<p>The DevOps/MLOps/Platform team:</p>
<ol>
<li>creates the FSx for NetApp ONTAP file system, the storage virtual machines (SVM) and the credentials secrets</li>
<li>installs the Trident CSI driver, provides the required IAM permissions and defines a Trident CSI storage class</li>
<li>defines a Trident NAS backend using the file system, SVM and the credentials</li>
<li>defines and deploys a dynamic provision PVC, with the above storage class, shared to the application namespace</li>
<li>implements a Kubernetes job that mounts the PVC and downloads the model onto the corresponding volume</li>
<li>triggers the job for each model that is uploaded to S3 and “marked” as published (e.g., via tags)</li>
<li>alters the container image definition to exclude the model artifacts during the build stage</li>
<li>alters the application manifest to:<!-- -->
<ol>
<li>include a PVC that imports the shared PVC</li>
<li>define a volume for the application pod</li>
<li>mount the volume under the expected paths in the application container</li>
</ol>
</li>
</ol>
<p>ML or application teams:</p>
<ol>
<li>upload model artifacts to an Amazon S3 bucket (as part of their SDLC) or Git LFS</li>
<li>continue to push their container image changes to Amazon ECR, as before</li>
<li>continue to use the Kubernetes deployment manifests to define the application Kubernetes deployment, as before</li>
</ol>
<p>To further illustrate the above steps, what follows is a collection of the relevant code examples for the most important parts of the implementation.</p>
<p>This is the storage class that to be handled by the Trident CSI driver:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: storage.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: StorageClass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: ontap-nas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">provisioner: csi.trident.netapp.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">volumeBindingMode: WaitForFirstConsumer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">parameters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  backendType: ontap-nas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fsType: ext4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">allowVolumeExpansion: True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reclaimPolicy: Delete</span><br></span></code></pre></div></div>
<p>This is the Trident backend configuration for the backend integration with FSx for NetApp ONTAP:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: trident.netapp.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: TridentBackendConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: svm1-nas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  backendName: svm1-nas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  storageDriverName: ontap-nas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  managementLIF: ${SVM_MGMT_DNS}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  svm: svm1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  aws:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fsxFilesystemID: ${FSXN_ID}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apiRegion: ${AWS_REGION}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  credentials:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: ${SVM_ADMIN_CREDS_SECRET_ARN}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type: awsarn</span><br></span></code></pre></div></div>
<p>This is an example of a PVC that is handled by Trident and is allowed to be shared across namespaces:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kind: PersistentVolumeClaim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: some-model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    trident.netapp.io/shareToNamespace: apps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  storageClassName: ontap-nas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  accessModes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - ReadWriteMany</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      storage: 20Gi</span><br></span></code></pre></div></div>
<p>We can the use a Job that mounts the PVC and populates the FSx for NetApp ONTAP volume behind its dynamic PV with data from S3:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: batch/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: fsxn-loader-some-model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    job-type: fsxn-loader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pvc: some-model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  backoffLimit: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ttlSecondsAfterFinished: 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        job-type: fsxn-loader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pvc: some-model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      restartPolicy: Never</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: loader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          image: peakcom/s5cmd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          command:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - /bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - -c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - &#x27;/s5cmd sync --delete s3://${MODELS_BUCKET}/${MODELS_FOLDER}/some-model/* /model&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              mountPath: /model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          persistentVolumeClaim:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            claimName: some-model</span><br></span></code></pre></div></div>
<p>Now the PVC exists in the cluster and can be consumed, via Trident PVC sharing defined by the <code>TridentVolumeReference</code> CR, by the application in the <code>apps</code> namespace:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: trident.netapp.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: TridentVolumeReference</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: some-model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace:apps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pvcName: some-model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pvcNamespace: kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: PersistentVolumeClaim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: some-model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: apps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    trident.netapp.io/shareFromPVC: kube-system/some-model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  storageClassName: ontap-nas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  accessModes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - ReadOnlyMany</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      storage: 20Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: some-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: apps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app.kubernetes.io/name: some-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app.kubernetes.io/name: some-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          image: some-app:1.2.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: data-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              mountPath: /app/models/some-model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: data-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          persistentVolumeClaim:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            claimName: some-model</span><br></span></code></pre></div></div>
<p><strong>Main benefits</strong></p>
<p>This solution implements the high-level approach of improving AI/ML inference application containers startup performance by reducing the container image size. It improves the time it takes for the model artifacts to become available for the application (since it no longer needs to download them).</p>
<p><strong>Additional benefits</strong></p>
<p>In addition to the main benefit, the solution introduces the following potential additional benefits:</p>
<ul>
<li>Ability to update model versions separately from the application, without rebuilding the container image</li>
<li>Ability to A/B test, hot-swap or rollback models, without rebuilding or increasing the container image size</li>
<li>Ability to share models between different applications without packaging them into all container images</li>
<li>Kubernetes-driven provision and access control via Trident clone, share and snapshot-related features, which reduce the need to copy models, create new operation</li>
<li>Ability to have a POSIX-based access control to models</li>
<li>Faster container builds, aiding experimentation and testing</li>
<li>Minimal changes in the ML or application teams workflow</li>
</ul>
<p><strong>Trade-offs</strong></p>
<p>The trade-offs include:</p>
<ul>
<li>Additional operational complexity of making the required CI/CD changes and maintaining the loader process</li>
<li>Additional software (Trident) to operate and maintain</li>
<li>The need to implement a custom S3/FSx for NetApp ONTAP TTL/retention-related mechanism to reduce storage cost</li>
<li>Read performance for the model artifacts needs to be measured against container image download time</li>
<li>More complex cross-region replication</li>
</ul>
<p><strong>Variants and hybrid solutions</strong></p>
<p>This solution integrates well with the <a href="/ai-on-eks/docs/guidance/container-startup-time/accelerate-pull-process">Accelerating pull process</a> group of solutions, improving both the container image size and its pull time.</p>
<p>For AI/ML inference application that read the artifacts into memory this also allows to skip the intermediate step of storing them on the local disk, similar to the “Using Mountpoint CSI Driver to read model artifacts into memory directly from Amazon S3” solution, and can be used instead (or in addition) to improve the download performance further.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="baking-model-artifacts-into-a-custom-amazon-ami">Baking model artifacts into a custom Amazon AMI<a href="#baking-model-artifacts-into-a-custom-amazon-ami" class="hash-link" aria-label="Direct link to Baking model artifacts into a custom Amazon AMI" title="Direct link to Baking model artifacts into a custom Amazon AMI">​</a></h2>
<p><strong>Architecture overview</strong></p>
<p><img decoding="async" loading="lazy" alt="Figure 3: Baking model artifacts into a custom Amazon AMI" src="/ai-on-eks/assets/images/custom-ami-967880e368b01f8162b83437cc95c3ef.png" width="8140" height="3644" class="img_ev3q"></p>
<p>Figure 3: Baking model artifacts into a custom Amazon AMI</p>
<p>This solution may be suitable in environments with very infrequently changing models that are extremely sensitive to startup time latency and with limited network connectivity.</p>
<p><strong>Implementation guide</strong></p>
<p>Following the architecture diagram above, these are the main high-level steps for each of the teams.</p>
<p>The DevOps/MLOps/Platform team:</p>
<ol>
<li>creates the EC2 Image Builder recipe ro Packer template and pushes it to Git</li>
<li>updates the CI/CD process to include AMI backing steps</li>
<li>creates the corresponding Karpenter node pools that use the AMI</li>
<li>alters the application manifest to include node selector for a node pool to be provided as a parameter</li>
</ol>
<p>ML or application teams:</p>
<ol>
<li>upload model artifacts to an Amazon S3 bucket (as part of their SDLC) or Git LFS</li>
<li>continue to push their container image changes to Amazon ECR, as before</li>
<li>provides the appropriate model-specific node pool labels as parameters to the Kubernetes manifest deployment</li>
</ol>
<p><strong>Main benefits</strong></p>
<p>The solution provides the following main benefits:</p>
<ul>
<li>no download latency as the models are available immediately upon container start</li>
<li>no network dependency</li>
</ul>
<p><strong>Additional benefits</strong></p>
<p>In addition to the main benefit, the solution introduces the following potential additional benefits:</p>
<ul>
<li>no changes to Kubernetes artifacts</li>
<li>streamlined rollout for new model versions via Karpenter drift detection</li>
<li>no need to depend on additional services like S3 of FSx</li>
</ul>
<p><strong>Trade-offs</strong></p>
<p>The trade-offs include:</p>
<ul>
<li>Significant additional operational complexity of integrating Image Builder or Packer into the CI/CD process</li>
<li>Slower build times and longer feedback loop for experimentation, debugging and testing due a more complex setup that requires access to the AMI on a running instance</li>
<li>Storage cost if co-locating all models or extreme cluster segmentation with a AMI-per-model approach, since it requires to manage scheduling of the applications to their corresponding AMIs.</li>
</ul>
<p><strong>Variants and hybrid solutions</strong></p>
<p>This solution integrates well with the <a href="/ai-on-eks/docs/guidance/container-startup-time/accelerate-pull-process">Accelerating pull process</a> group of solutions, improving both the container image size and its pull time.</p>
<blockquote>
<p>Note that this can introduce regression in accuracy or compatibility issues with serving frameworks.</p>
</blockquote></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/awslabs/ai-on-eks/blob/main/website/docs/guidance/container-startup-time/1-reduce-container-image-size/14-decoupling-model-artifacts.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/ai-on-eks/docs/guidance/container-startup-time/reduce-container-image-size/optimize-image-size"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Optimizing container images size</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/ai-on-eks/docs/guidance/container-startup-time/accelerate-pull-process"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Accelerating pull process</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#using-init-containers-to-download-model-artifacts-from-amazon-s3" class="table-of-contents__link toc-highlight">Using init containers to download model artifacts from Amazon S3</a></li><li><a href="#using-amazon-file-storage-services-to-host-model-artifacts" class="table-of-contents__link toc-highlight">Using Amazon File Storage services to host model artifacts</a><ul><li><a href="#using-trident-csi-driver-to-provide-access-to-model-artifacts-on-amazon-fsx-for-netapp-ontap" class="table-of-contents__link toc-highlight">Using Trident CSI driver to provide access to model artifacts on Amazon FSx for NetApp ONTAP</a></li></ul></li><li><a href="#baking-model-artifacts-into-a-custom-amazon-ami" class="table-of-contents__link toc-highlight">Baking model artifacts into a custom Amazon AMI</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Get Involved</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/awslabs/ai-on-eks" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Built with ❤️ at AWS  <br> © 2025 Amazon.com, Inc. or its affiliates. All Rights Reserved</div></div></div></footer><script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;7fbc7ab02fae4767b1af2588eba0cdf2&quot;}"></script></div>
</body>
</html>